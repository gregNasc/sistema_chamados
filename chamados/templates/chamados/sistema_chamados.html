{% extends "base.html" %}
{% load static %}

{% block content %}
<h1 class="text-2xl font-bold mb-6 text-gray-800">üìã Sistema de Chamados</h1>

<!-- ALERTA DE MENSAGEM -->
{% if messages %}
<div id="mensagem-alerta" class="p-2 mb-4 rounded bg-green-100 text-green-800">
    {% for message in messages %}
        {{ message }}
    {% endfor %}
</div>
<script>
  setTimeout(() => {
    const alerta = document.getElementById('mensagem-alerta');
    if(alerta) alerta.remove();
  }, 3000);

  const formChamado = document.getElementById('form-chamado');
  if(formChamado) formChamado.reset();
</script>
{% endif %}

<!-- Filtro por data -->
<form method="get" id="form-filtro" class="flex items-center gap-3 mb-6">
    <label for="data" class="text-sm font-medium">Filtrar por Data:</label>
    <input type="date" id="data" name="data" value="{{ data_selecionada }}"
           class="px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
    <button type="submit"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
        Filtrar
    </button>
</form>

<hr class="my-6">

<!-- Formul√°rio de cadastro de chamado -->
<h2 class="text-xl font-semibold mb-4 text-gray-700">üìå Cadastrar Chamado</h2>

<form method="post" id="form-chamado" class="space-y-4 bg-white p-6 rounded-2xl shadow">
    {% csrf_token %}

    <!-- Regional -->
    <div>
        <label for="regional" class="block text-sm font-medium mb-1">Regional</label>
        <select name="regional" id="regional"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
            <option value="">Selecione uma Regional</option>
            {% for r in regionais %}
                <option value="{{ r }}" {% if r == regional_selecionada %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Loja -->
    <div>
        <label for="loja" class="block text-sm font-medium mb-1">Loja</label>
        <select name="loja" id="loja"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
            <option value="">Selecione uma Loja</option>
            {% for l in lojas %}
                <option value="{{ l }}" {% if l == loja_selecionada %}selected{% endif %}>{{ l }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- L√≠der -->
    <div>
        <label for="lider" class="block text-sm font-medium mb-1">L√≠der</label>
        <input list="lideres" name="lider" id="lider"
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm uppercase"
               value="{{ lider_selecionado }}">
        <datalist id="lideres">
            {% for lider in lideres %}
                <option value="{{ lider }}">
            {% endfor %}
        </datalist>
    </div>

    <!-- Motivo -->
    <div>
        <label for="motivo" class="block text-sm font-medium mb-1">Motivo</label>
        <select name="motivo" id="motivo"
                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
            <option value="">Selecione um Motivo</option>
        </select>
    </div>

    <!-- Outro Motivo -->
    <div id="div_outro_motivo" style="display:none;">
        <label for="outro_motivo" class="block text-sm font-medium mb-1">Outro Motivo</label>
        <input type="text" name="outro_motivo" id="outro_motivo"
               placeholder="Especifique outro motivo"
               value="{{ form.outro_motivo.value|default:'' }}"
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm uppercase">
    </div>

    <button type="submit"
            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
        üíæ Salvar Chamado
    </button>
</form>

<!-- Lista de chamados -->
<h2 class="text-xl font-semibold mt-10 mb-4 text-gray-700">üìÇ Chamados Abertos</h2>

{% if chamados %}
<div class="overflow-x-auto bg-white rounded-2xl shadow">
    <table class="w-full text-sm text-left border-collapse">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold">
            <tr>
                <th class="px-6 py-3">Regional</th>
                <th class="px-6 py-3">Loja</th>
                <th class="px-6 py-3">L√≠der</th>
                <th class="px-6 py-3">Motivo</th>
                <th class="px-6 py-3">Usu√°rio</th>
                <th class="px-6 py-3">Data de Cria√ß√£o</th>
                <th class="px-6 py-3">A√ß√£o</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for chamado in chamados %}
            <tr class="hover:bg-gray-50 transition" data-status="{{ chamado.status }}">
                <td class="px-4 py-2">{{ chamado.regional }}</td>
                <td class="px-4 py-2">{{ chamado.loja }}</td>
                <td class="px-4 py-2">{{ chamado.lider }}</td>
                <td class="px-6 py-3">
                    {% if chamado.motivo == "OUTRO" and chamado.outro_motivo %}
                        {{ chamado.motivo }}: {{ chamado.outro_motivo }}
                    {% else %}
                        {{ chamado.motivo }}
                    {% endif %}
                </td>
                <td class="px-4 py-2">{{ chamado.usuario }}</td>
                <td class="px-6 py-3">{{ chamado.abertura|date:"d/m/Y H:i" }}</td>
                <td class="px-6 py-3">
                    <button class="px-3 py-1 bg-yellow-400 text-white rounded-lg hover:bg-yellow-500 transition text-xs"
                            onclick="abrirModal({{ chamado.id }})">
                        Finalizar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-gray-500 italic">N√£o h√° chamados abertos.</p>
{% endif %}

<a href="{% url 'chamados:todos_chamados' %}"
   class="inline-block mt-6 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
   üîé Ver todos os chamados
</a>

<!-- Modal Finalizar Chamado -->
<div id="modal-finalizar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-2xl shadow w-96">
        <h2 class="text-lg font-bold mb-4">Finalizar Chamado {{ chamado.loja }}</h2>
        <form method="post" id="form-finalizar">
            {% csrf_token %}

            <!-- Observa√ß√£o -->
            <label>Deseja acrescentar uma observa√ß√£o?</label>
            <select name="adicionar_obs" onchange="toggleObservacao(this)" class="w-full mb-3 border rounded px-2 py-1">
                <option value="N√£o">N√£o</option>
                <option value="Sim">Sim</option>
            </select>
            <textarea name="observacao" id="observacao" style="display:none" class="w-full border rounded px-2 py-1 mb-3"></textarea>

             <!-- Tempo m√©dio manual -->
            <label>Deseja acrescentar o tempo m√©dio manualmente?</label>
            <select name="usar_tempo_manual" onchange="toggleTempoManual(this)"
                    class="w-full mb-3 border rounded px-2 py-1">
                <option value="N√£o">N√£o</option>
                <option value="Sim">Sim</option>
            </select>
            <input type="number" name="tempo_manual" id="tempo_manual" min="1" placeholder="Minutos"
                   style="display:none" class="w-full border rounded px-2 py-1 mb-3">

            <div class="flex justify-end gap-2">
                <button type="button" onclick="fecharModal()"
                        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar</button>
                <button type="submit"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Confirmar</button>
            </div>
        </form>
    </div>
</div>



<!-- Modal Timer-->
<div id="chamadoModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg p-6 w-80 shadow-lg">
        <h2 class="text-lg font-bold mb-4" id="modalLoja">Chamado</h2>
        <p id="modalTexto" class="mb-6">O chamado ainda da loja {{ chamado.loja }} ainda est√° aberto!</p>
        <div class="flex justify-end gap-2">
            <button id="btnSim" class="px-4 py-2 bg-green-500 text-white rounded">OK</button>
        </div>
    </div>
</div>


<!-- BOT√ÉO FLUTUANTE DO CHAT -->
<button id="abrir-chat"
         class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 hover:scale-110 transition transform z- animate-bounce">
    üí¨
</button>

<!-- MODAL DO CHAT -->
<div id="chat-modal"
     class="fixed inset-0 bg-black bg-opacity-40 flex items-end justify-end hidden z-50">
    <div class="bg-white w-80 h-96 rounded-t-2xl shadow-lg flex flex-col p-3 m-4 relative">
    <div id="chat-alerts" class="fixed top-6 right-6 w-80 z-50 space-y-2"></div>
        <!-- Cabe√ßalho -->
        <div class="flex justify-between items-center border-b pb-2 mb-2">
            <h3 class="font-semibold text-gray-700">üí¨ Suporte</h3>
            <button id="fechar-chat" class="text-gray-400 hover:text-gray-600">‚úñ</button>
        </div>

        <!-- Mensagens -->
        <div id="chat-messages" class="flex-1 overflow-y-auto border rounded p-2 mb-2 bg-gray-50"></div>

        <!-- Campo de envio -->
        <div class="flex gap-2">
            <input type="text" id="chat-input"
                   class="border flex-1 p-2 rounded focus:ring focus:ring-blue-300 text-sm"
                   placeholder="Digite sua mensagem...">
            <button id="chat-send"
                    class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 transition">
                ‚û§
            </button>
        </div>

    </div>
</div>
{% if request.user.is_staff %}
  {% if usuarios %}
    <ul id="lista-usuarios">
      {% for usuario in usuarios %}
        <li>
          <button class="abrir-chat-usuario" data-username="{{ usuario.username }}">
            {{ usuario.get_full_name|default:usuario.username }}
          </button>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Nenhum usu√°rio dispon√≠vel.</p>
  {% endif %}
{% endif %}
<div id="chat-info"
     data-user-id="{{ request.user.id }}"
     data-user-nome="{{ request.user.get_full_name|default:request.user.username }}">
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'chamados/scripts.js' %}"></script>

<script>
function inicializarFormulario() {
    const motivosFixos = [
        '',
        'FALHA NA IMPRESS√ÉO',
        'IMPRESSORA QUEIMADA',
        'ROUTER N√ÉO FUNCIONA',
        'NOTEBOOK N√ÉO LIGA',
        'COLETOR N√ÉO CONECTA NA REDE',
        'OUTRO'
    ];

    const motivosDB = [
        {% for m in form.fields.motivo.choices %}
            '{{ m.0 }}',
        {% endfor %}
    ].filter(m => !motivosFixos.includes(m));

    const todosMotivos = motivosFixos.concat(motivosDB);
    const motivoSelect = document.getElementById('motivo');

    motivoSelect.innerHTML = '';
    todosMotivos.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        option.textContent = m;
        if ("{{ form.motivo.value }}" === m) option.selected = true;
        motivoSelect.appendChild(option);
    });

    const outroDiv = document.getElementById('div_outro_motivo');
    outroDiv.style.display = motivoSelect.value === 'OUTRO' ? 'block' : 'none';

    motivoSelect.addEventListener('change', () => {
        outroDiv.style.display = motivoSelect.value === 'OUTRO' ? 'block' : 'none';
    });
}

window.addEventListener('DOMContentLoaded', () => {
    inicializarFormulario();

    // Filtro de chamados abertos (apenas frontend)
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.dataset.status !== 'Aberto') {
            row.style.display = 'none';
        }
    });
});

window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
        inicializarFormulario();
    }
});

$(function(){
    function atualizarLojas(selecionarValor=false) {
        let data = $('#data').val();
        let regional = $('#regional').val();
        $.getJSON("{% url 'chamados:lojas_por_regional' %}", {data, regional}, function(resp){
            let lojaSelect = $('#loja');
            lojaSelect.empty().append('<option value="">Selecione uma Loja</option>');
            resp.lojas.forEach(loja => lojaSelect.append(`<option value="${loja}">${loja}</option>`));
            if(selecionarValor && resp.lojas.length > 0) lojaSelect.val(resp.lojas[0]).change();
            $('#lider').val('');
        });
    }

    function atualizarLider() {
        let data = $('#data').val();
        let loja = $('#loja').val();
        $.getJSON("{% url 'chamados:lider_por_loja' %}", {data, loja}, function(resp){
            let datalist = $('#lideres');
            datalist.empty();
            if(resp.lider){
                datalist.append(`<option value="${resp.lider}">`);
                $('#lider').val(resp.lider);
            } else $('#lider').val('');
        });
    }

    $('#regional').change(() => atualizarLojas(true));
    $('#loja').change(atualizarLider);

    if ($('#regional').val()) {
        atualizarLojas(true);
        atualizarLider();
    }
});

function abrirModal(id){
    $('#modal-finalizar').show();
    $('#form-finalizar').attr('action', `/finalizar/${id}/`);
    $('#observacao').hide();
}

function fecharModal(){
    $('#modal-finalizar').hide();
}

function toggleObservacao(select) {
    const textarea = document.getElementById('observacao');
    textarea.style.display = select.value === 'Sim' ? 'block' : 'none';
}

function toggleTempoManual(select) {
    const input = document.getElementById('tempo_manual');
    if (select.value === 'Sim') {
        input.style.display = 'block';
    } else {
        input.style.display = 'none';
        input.value = '';  // limpa o valor quando n√£o for usado
    }
}

    document.getElementById('form-finalizar').addEventListener('submit', function (e) {
    const usarTempoManual = document.querySelector('[name="usar_tempo_manual"]').value;
    const tempoManual = document.getElementById('tempo_manual');

    // Se o usu√°rio marcou "Sim", mas n√£o digitou nada
    if (usarTempoManual === 'Sim' && tempoManual.value === '') {
        e.preventDefault();
        alert('‚ö†Ô∏è Por favor, informe o tempo manual antes de confirmar.');
        tempoManual.focus();
        return;
    }

    // Se marcou "N√£o", limpa o campo antes de enviar
    if (usarTempoManual === 'N√£o') {
        tempoManual.value = '';
    }

    tempoManual.disabled = false;
});

</script>

<script>
    const modal = document.getElementById('chamadoModal');
    const modalLoja = document.getElementById('modalLoja');
    const modalTexto = document.getElementById('modalTexto');
    const btnOk = document.getElementById('btnSim'); // Agora s√≥ um bot√£o "OK"

    // Lista de lojas abertas do backend
    const chamadosAbertos = [
        {% for chamado in chamados %}
            "{{ chamado.loja }}",
        {% endfor %}
    ];

    // Armazena lojas que j√° foram exibidas (evita repetir)
    const lojasExibidas = new Set();

    // Fun√ß√£o para mostrar um modal para uma loja espec√≠fica
    function mostrarModal(loja, callback) {
        if (lojasExibidas.has(loja)) {
            callback();
            return;
        }

        modalLoja.textContent = `Chamado ${loja}`;
        modalTexto.textContent = `O chamado da loja ${loja} ainda est√° aberto!`;
        modal.classList.remove('hidden');

        btnOk.onclick = () => {
            lojasExibidas.add(loja);
            modal.classList.add('hidden');
            callback();
        };
    }

    // Fun√ß√£o para exibir os modais em sequ√™ncia com delay
    function mostrarChamadosSequenciais(lojas, index = 0) {
        if (index >= lojas.length) return; // acabou a lista
        mostrarModal(lojas[index], () => {
            // Delay curto antes de mostrar o pr√≥ximo modal
            setTimeout(() => mostrarChamadosSequenciais(lojas, index + 1), 300);
        });
    }

    // Executa a sequ√™ncia ao carregar a p√°gina
    if (chamadosAbertos.length > 0) {
        mostrarChamadosSequenciais(chamadosAbertos);
    }
</script>


<script>
// ------------------------
// CHAT USU√ÅRIO
// ------------------------
document.addEventListener('DOMContentLoaded', function() {
    const usuarioId = "{{ request.user.id }}"; // ID do usu√°rio logado
    const usuarioNome = "{{ request.user.get_full_name|default:request.user.username }}";
    const chatModal = document.getElementById('chat-modal');
    const abrirChatBtn = document.getElementById('abrir-chat');
    const fecharChatBtn = document.getElementById('fechar-chat');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    abrirChatBtn.addEventListener('click', () => chatModal.classList.remove('hidden'));
    fecharChatBtn.addEventListener('click', () => chatModal.classList.add('hidden'));
    chatModal.addEventListener('click', e => {
        if(e.target === chatModal) chatModal.classList.add('hidden');
    });

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/chat/{{ request.user.username }}/');

    chatSocket.onopen = () => console.log("‚úÖ Usu√°rio conectado ao WebSocket");
    chatSocket.onerror = err => console.error("‚ùå Erro WebSocket usu√°rio:", err);

chatSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const msgEl = document.createElement('div');

    if (data.admin === true) {
        // Mensagem do admin
        msgEl.textContent = `${data.remetente}: ${data.mensagem}`;
        msgEl.className = "mb-1 text-sm text-blue-600";
    } else {
        // Mensagem do pr√≥prio usu√°rio
        if (data.usuario_nome === usuarioNome) {
            msgEl.textContent = `${data.usuario_nome}: ${data.mensagem}`;
            msgEl.className = "mb-1 text-sm text-gray-800 text-right";
        } else {
            // Mensagem de outro usu√°rio (n√£o aplic√°vel) ou alert
            msgEl.textContent = `${data.remetente || data.usuario_nome || 'Usu√°rio'}: ${data.mensagem}`;
            msgEl.className = "mb-1 text-sm text-gray-700";
        }

        // Alerta apenas se for de outro usu√°rio/admin
        if (data.alert && data.usuario_nome !== usuarioNome) {
            alert(`Nova mensagem de ${data.usuario_nome}!`);
        }
    }

    chatMessages.appendChild(msgEl);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

    function enviarMensagemUsuario() {
        const mensagem = chatInput.value.trim();
        if(!mensagem) return;

        chatSocket.send(JSON.stringify({mensagem, admin: false}));
        chatInput.value = '';
    }

    chatSend.addEventListener('click', enviarMensagemUsuario);
    chatInput.addEventListener('keypress', e => { if(e.key === 'Enter') enviarMensagemUsuario(); });
});

</script>

{% if request.user.is_staff %}
<script>
// ------------------------
// CHAT ADMIN SIMPLIFICADO
// ------------------------
document.addEventListener('DOMContentLoaded', function() {
    const isAdmin = {{ request.user.is_staff|yesno:"true,false" }};
    if(!isAdmin) return; // S√≥ admins entram aqui

    const chatModal = document.getElementById('chat-modal');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";

    let chatSocket = null;
    let usuarioAtivo = null;

    // Container de alertas visuais
    let alertContainer = document.getElementById('chat-alerts');
    if(!alertContainer){
        alertContainer = document.createElement('div');
        alertContainer.id = 'chat-alerts';
        alertContainer.className = 'fixed top-6 right-6 z-50 flex flex-col gap-2';
        document.body.appendChild(alertContainer);
    }

    function criarAlerta(msg){
        const alertEl = document.createElement('div');
        alertEl.textContent = msg;
        alertEl.className = "p-2 bg-yellow-200 border border-yellow-400 rounded shadow text-sm";
        alertContainer.appendChild(alertEl);
        console.log("üîî Alerta:", msg);
        setTimeout(() => alertEl.remove(), 5000);
    }

    // Inicializa o socket para o usu√°rio selecionado
    function iniciarSocket(usuario){
        usuarioAtivo = usuario;
        if(chatSocket) chatSocket.close();
        chatMessages.innerHTML = '';

        chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${usuarioAtivo}/`);

        chatSocket.onopen = () => console.log(`‚úÖ Conectado ao chat de ${usuarioAtivo}`);
        chatSocket.onerror = err => console.error("‚ùå Erro WebSocket:", err);

        chatSocket.onmessage = function(event){
            const data = JSON.parse(event.data);
            console.log("üì• Mensagem recebida:", data);

            const msgEl = document.createElement('div');
            const remetente = data.remetente || "Usu√°rio";

            msgEl.textContent = `${remetente}: ${data.mensagem}`;
            msgEl.className = data.admin ? "mb-1 text-sm text-blue-600" : "mb-1 text-sm text-gray-800";

            // Alerta se a mensagem √© de outro usu√°rio
            if(data.alert && data.usuario_nome !== usuarioAtivo) criarAlerta(`Nova mensagem de ${data.usuario_nome}!`);

            chatMessages.appendChild(msgEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Enviar mensagem como admin
    function enviarMensagemAdmin(){
        const texto = chatInput.value.trim();
        if(!texto || !usuarioAtivo) return;

        const payload = {
            mensagem: texto,
            admin: true,
            destinatario_username: usuarioAtivo
        };
        console.log("üì§ Enviando mensagem:", payload);
        chatSocket.send(JSON.stringify(payload));
        chatInput.value = '';
    }

    // Eventos de envio
    chatSend.addEventListener('click', enviarMensagemAdmin);
    chatInput.addEventListener('keypress', e => { if(e.key === 'Enter') enviarMensagemAdmin(); });

    // Clique em usu√°rio na lista
    document.querySelectorAll('.abrir-chat-usuario').forEach(btn => {
        btn.addEventListener('click', () => {
            const username = btn.dataset.username;
            usuarioAtivo = username;
            console.log("üë§ Abrindo chat com:", username);
            iniciarSocket(usuarioAtivo);
            chatModal.classList.remove('hidden');
        });
    });

    // Fechar/abrir modal
    document.getElementById('abrir-chat')?.addEventListener('click', ()=>chatModal.classList.remove('hidden'));
    document.getElementById('fechar-chat')?.addEventListener('click', ()=>chatModal.classList.add('hidden'));
    chatModal?.addEventListener('click', e => { if(e.target === chatModal) chatModal.classList.add('hidden'); });
});
</script>
{% endif %}

{% endblock %}