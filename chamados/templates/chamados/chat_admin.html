<div class="flex gap-4">
    <!-- Lista de usu치rios -->
    <div class="w-1/3 border p-2 h-[500px] overflow-y-auto">
        <h3 class="font-bold mb-2">Usu치rios</h3>
        <ul id="user-list">
            {% for user in usuarios %}
                <li>
                    <a href="#" class="user-link" data-user-id="{{ user.id }}">{{ user.username }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Chat do usu치rio selecionado -->
    <div class="w-2/3 border p-4 rounded">
        <h3 id="chat-title" class="font-bold mb-2">游눫 Chat</h3>
        <div id="chat-messages" class="border h-64 overflow-y-auto p-2 mb-2"></div>
        <input type="text" id="chat-input" class="border w-full p-2" placeholder="Digite sua mensagem...">
        <button id="chat-send" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">Enviar</button>
    </div>
</div>


let selectedUserId = null;
let chatSocket = null;

const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const userLinks = document.querySelectorAll('.user-link');
const chatTitle = document.getElementById('chat-title');

userLinks.forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();

        // Fecha socket anterior
        if (chatSocket) {
            chatSocket.close();
        }

        selectedUserId = this.dataset.userId;
        chatTitle.textContent = `游눫 Chat com ${this.textContent}`;
        chatMessages.innerHTML = '';

        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        chatSocket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/chat/${selectedUserId}/`);

        chatSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const mensagemEl = document.createElement('div');
            mensagemEl.textContent = (data.admin ? "Admin: " : "Usu치rio: ") + data.mensagem;
            mensagemEl.classList.add(data.admin ? 'text-red-600' : 'text-gray-800');
            chatMessages.appendChild(mensagemEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
    });
});

chatSend.addEventListener('click', function() {
    const mensagem = chatInput.value.trim();
    if (mensagem && chatSocket) {
        chatSocket.send(JSON.stringify({'mensagem': mensagem, 'admin': true}));
        chatInput.value = '';
    }
});

chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') chatSend.click();
});